<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Railways AI-Powered Health Index</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <style>
        body {
            background: linear-gradient(to bottom, #1E3A8A, #111827);
            font-family: 'Lora', serif;
            color: #F3F4F6;
            min-height: 100vh;
        }
        .train-animation {
            animation: moveTrain 12s linear infinite;
        }
        @keyframes moveTrain {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100vw); }
        }
        .platform-board {
            background: #1F2937;
            color: #FBBF24;
            font-family: 'Courier New', monospace;
            padding: 0.75rem;
            border: 3px solid #F97316;
            transition: box-shadow 0.3s, transform 0.2s;
        }
        .platform-board:focus {
            box-shadow: 0 0 15px #F97316;
            transform: scale(1.02);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #1F2937;
            padding: 2.5rem;
            border-radius: 12px;
            max-width: 90%;
            max-height: 85%;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .progress-bar {
            background: #4B5563;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar-fill {
            background: linear-gradient(to right, #16A34A, #22C55E);
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in {
            animation: slideIn 0.6s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        button:hover {
            transform: scale(1.05);
            transition: transform 0.2s, background-color 0.3s;
        }
        #suggestions {
            background: #1F2937;
            border: 1px solid #F97316;
            max-height: 250px;
            overflow-y: auto;
            position: absolute;
            width: 100%;
            z-index: 20;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #suggestions div {
            padding: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        #suggestions div:hover {
            background: #F97316;
            color: #1F2937;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .glow-on-hover:hover {
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.5);
        }
        .train-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .train-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(249, 115, 22, 0.3);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white text-center py-6 md:py-8 shadow-lg">
        <h1 class="text-3xl md:text-5xl font-bold flex items-center justify-center">
            <i class="fas fa-train mr-3 train-animation"></i> Indian Railways AI-Powered Health Index
        </h1>
        <div class="mt-4 flex justify-center space-x-4">
            <button id="toggle-dark" class="bg-gray-700 text-white px-4 py-2 rounded-full hover:bg-gray-600 focus:outline-none">
                <i class="fas fa-moon"></i> Dark Mode
            </button>
            <button id="toggle-sound" class="bg-saffron-600 text-white px-4 py-2 rounded-full hover:bg-saffron-700">
                <i class="fas fa-volume-up"></i> Sound Off
            </button>
        </div>
    </header>

    <main class="flex-grow container mx-auto p-4 md:p-8">
        <section id="auth-section" class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
            <div id="login-section" class="glassmorphism p-6 rounded-xl shadow-xl glow-on-hover">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 text-blue-300"><i class="fas fa-sign-in-alt"></i> Board Now</h2>
                <div class="space-y-6">
                    <div>
                        <label for="login-username" class="block text-sm font-medium text-gray-300">Username</label>
                        <input type="text" id="login-username" class="w-full p-3 border border-gray-500 rounded-md bg-gray-800 text-white focus:ring-blue-500" aria-label="Login username">
                    </div>
                    <div>
                        <label for="login-password" class="block text-sm font-medium text-gray-300">Password</label>
                        <input type="password" id="login-password" class="w-full p-3 border border-gray-500 rounded-md bg-gray-800 text-white focus:ring-blue-500" aria-label="Login password">
                    </div>
                    <button id="login-btn" class="w-full bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 glow-on-hover">Board</button>
                    <p class="text-center text-sm text-gray-400">Don't have an account? <a href="#" id="show-register" class="text-blue-400 hover:underline">Register</a></p>
                </div>
            </div>
            <div id="register-section" class="glassmorphism p-6 rounded-xl shadow-xl glow-on-hover hidden">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 text-blue-300"><i class="fas fa-user-plus"></i> Join the Journey</h2>
                <div class="space-y-6">
                    <div>
                        <label for="register-username" class="block text-sm font-medium text-gray-300">Username</label>
                        <input type="text" id="register-username" class="w-full p-3 border border-gray-500 rounded-md bg-gray-800 text-white focus:ring-blue-500" aria-label="Register username">
                    </div>
                    <div>
                        <label for="register-password" class="block text-sm font-medium text-gray-300">Password</label>
                        <input type="password" id="register-password" class="w-full p-3 border border-gray-500 rounded-md bg-gray-800 text-white focus:ring-blue-500" aria-label="Register password">
                    </div>
                    <button id="register-btn" class="w-full bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 glow-on-hover">Register</button>
                    <p class="text-center text-sm text-gray-400">Already have an account? <a href="#" id="show-login" class="text-blue-400 hover:underline">Board Now</a></p>
                </div>
            </div>
        </section>

        <section id="main-content" class="hidden">
            <div class="glassmorphism p-6 md:p-8 rounded-xl shadow-xl mb-8 glow-on-hover">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 text-blue-300 slide-in"><i class="fas fa-tachometer-alt"></i> Train Health Index</h2>
                <div class="mb-6 relative">
                    <label for="train-number" class="block text-sm font-medium mb-2 text-gray-300">Enter Train Number</label>
                    <input type="text" id="train-number" class="w-full p-3 platform-board focus:ring-0" placeholder="e.g., 107" aria-label="Train number input" autocomplete="off">
                    <div id="suggestions" class="hidden"></div>
                </div>
                <div class="flex flex-col md:flex-row gap-4">
                    <button id="get-thi" class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 glow-on-hover">
                        <i class="fas fa-search"></i> Get Health Index
                    </button>
                    <button id="show-ai-features" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 glow-on-hover">
                        <i class="fas fa-robot"></i> AI Features
                    </button>
                    <button id="export-report" class="bg-indigo-600 text-white px-6 py-3 rounded-md hover:bg-indigo-700 glow-on-hover">
                        <i class="fas fa-file-download"></i> Export Report
                    </button>
                </div>
                <div id="train-not-found" class="hidden text-red-400 mt-4">Train not found. Please enter a valid train number.</div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                    <div class="train-card glassmorphism p-6 rounded-lg">
                        <h3 class="text-xl font-bold mb-4 text-blue-300"><i class="fas fa-calendar-alt"></i> Train Schedule</h3>
                        <div id="train-table" class="overflow-x-auto fade-in">
                            <table class="w-full border-collapse text-sm">
                                <thead>
                                    <tr class="bg-blue-800 text-white">
                                        <th class="p-3">SEQ</th>
                                        <th class="p-3">Station (Code)</th>
                                        <th class="p-3">Arrival</th>
                                        <th class="p-3">Departure</th>
                                        <th class="p-3">Distance</th>
                                    </tr>
                                </thead>
                                <tbody id="train-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="train-card glassmorphism p-6 rounded-lg">
                        <h3 class="text-xl font-bold mb-4 text-blue-300"><i class="fas fa-microchip"></i> Sensor Data & THI</h3>
                        <div id="sensor-table" class="mb-6 fade-in"></div>
                        <div id="thi-score" class="mb-6 fade-in">
                            <p class="text-lg font-bold text-gray-300">THI Score: <span id="thi-value">0</span> / 100</p>
                            <div class="progress-bar h-6 w-full mt-2">
                                <div id="thi-progress" class="progress-bar-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        <div id="maintenance-suggestion" class="mb-6 fade-in text-gray-300"></div>
                        <canvas id="sensor-chart" class="w-full h-80 fade-in"></canvas>
                    </div>
                </div>
            </div>

            <div class="glassmorphism p-6 md:p-8 rounded-xl shadow-xl mb-8 glow-on-hover">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 text-blue-300"><i class="fas fa-star"></i> Favorite Trains</h2>
                <ul id="favorites-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></ul>
            </div>

            <div class="glassmorphism p-6 md:p-8 rounded-xl shadow-xl mb-8 glow-on-hover">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 text-blue-300"><i class="fas fa-map"></i> Route Map</h2>
                <div id="route-map" class="h-80 lg:h-96 w-full rounded-lg"></div>
            </div>

            <div class="glassmorphism p-6 md:p-8 rounded-xl shadow-xl mb-8 glow-on-hover">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 text-blue-300"><i class="fas fa-envelope"></i> Contact Us</h2>
                <div class="space-y-6">
                    <div>
                        <label for="contact-message" class="block text-sm font-medium text-gray-300">Your Feedback</label>
                        <textarea id="contact-message" class="w-full p-3 border border-gray-500 rounded-md bg-gray-800 text-white" rows="5" aria-label="Feedback textarea"></textarea>
                    </div>
                    <button id="contact-submit" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 glow-on-hover">Send</button>
                </div>
                <div id="sentiment-analysis" class="mt-4 text-gray-300"></div>
            </div>

            <button id="logout-btn" class="bg-red-600 text-white px-6 py-3 rounded-md hover:bg-red-700 glow-on-hover">
                <i class="fas fa-sign-out-alt"></i> Depart
            </button>
        </section>
    </main>

    <div id="ai-features-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl md:text-3xl font-bold mb-6 text-blue-300"><i class="fas fa-robot"></i> AI Features</h2>
            <ul id="ai-features-list" class="list-disc pl-6 space-y-2 text-gray-300"></ul>
            <button id="close-ai-modal" class="bg-gray-600 text-white px-6 py-3 rounded-md hover:bg-gray-700 mt-6">Close</button>
        </div>
    </div>

    <footer class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white text-center py-6">
        <p>© 2025 Indian Railways AI-Powered Health Index | <a href="mailto:contact@irhealthindex.in" class="hover:underline text-blue-300">Contact Us</a></p>
    </footer>

    <audio id="train-sound" src="https://freesound.org/data/previews/260/260614_4751946-lq.mp3"></audio>

    <script>
        let trainData = [];
        let sensorChart;
        let sensorDataHistory = {
            "Brake Temperature (°C)": [], "Axle Vibration (mm/s)": [], "Wheel Wear (%)": [],
            "Engine Load (%)": [], "Battery Voltage (V)": [], "Fuel Efficiency (km/L)": []
        };
        let timeSeries = [];

        // Load train data from JSON
        async function fetchTrainData() {
            try {
                const response = await fetch('train_max_distance_only.json');
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                trainData = await response.json();
                console.log('Train data loaded:', trainData.length, 'records');
                initializeAI();
            } catch (error) {
                console.error('Error loading train data:', error);
                alert('Failed to load train data. Please ensure train_data.json exists.');
                trainData = [];
            }
        }

        // Dark mode toggle
        document.getElementById('toggle-dark').addEventListener('click', () => {
            document.body.classList.toggle('bg-gray-900');
            document.querySelectorAll('.glassmorphism').forEach(el => {
                el.classList.toggle('bg-gray-800');
                el.classList.toggle('text-white');
            });
            document.getElementById('toggle-dark').innerHTML = document.body.classList.contains('bg-gray-900')
                ? '<i class="fas fa-sun"></i> Light Mode'
                : '<i class="fas fa-moon"></i> Dark Mode';
        });

        // Authentication
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const showRegister = document.getElementById('show-register');
        const showLogin = document.getElementById('show-login');
        const authSection = document.getElementById('auth-section');
        const mainContent = document.getElementById('main-content');
        const loginSection = document.getElementById('login-section');
        const registerSection = document.getElementById('register-section');

        showRegister.addEventListener('click', () => {
            loginSection.classList.add('hidden');
            registerSection.classList.remove('hidden');
        });

        showLogin.addEventListener('click', () => {
            registerSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
        });

        registerBtn.addEventListener('click', () => {
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            if (username && password) {
                localStorage.setItem('user_' + username, password);
                alert('Registration successful! Please board now.');
                registerSection.classList.add('hidden');
                loginSection.classList.remove('hidden');
            } else {
                alert('Please fill in all fields.');
            }
        });

        loginBtn.addEventListener('click', () => {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const storedPassword = localStorage.getItem('user_' + username);
            if (storedPassword && storedPassword === password) {
                authSection.classList.add('hidden');
                mainContent.classList.remove('hidden');
                updateUserPreferences(username);
            } else {
                alert('Invalid credentials.');
            }
        });

        logoutBtn.addEventListener('click', () => {
            authSection.classList.remove('hidden');
            mainContent.classList.add('hidden');
            loginSection.classList.remove('hidden');
            registerSection.classList.add('hidden');
        });

        // Sensor data generation
        function generateSensorData() {
            return {
                "Brake Temperature (°C)": Math.random() * (120 - 30) + 30,
                "Axle Vibration (mm/s)": Math.random() * (4.0 - 0.1) + 0.1,
                "Wheel Wear (%)": Math.random() * (90 - 10) + 10,
                "Engine Load (%)": Math.random() * (100 - 40) + 40,
                "Battery Voltage (V)": Math.random() * (14.5 - 10.5) + 10.5,
                "Fuel Efficiency (km/L)": Math.random() * (5 - 2) + 2
            };
        }

        // THI calculation
        function calculateTHI(sensorData, scheduleData) {
            let score = 100;
            // Sensor-based penalties
            if (sensorData["Brake Temperature (°C)"] > 90) score -= 15;
            if (sensorData["Axle Vibration (mm/s)"] > 2.5) score -= 20;
            if (sensorData["Wheel Wear (%)"] > 70) score -= 25;
            if (sensorData["Engine Load (%)"] > 85) score -= 10;
            if (sensorData["Battery Voltage (V)"] < 11) score -= 10;
            if (sensorData["Fuel Efficiency (km/L)"] < 3) score -= 10;
            // Schedule-based penalties
            const delays = scheduleData.reduce((sum, row) => {
                const stopTime = (row['Dep Time'] - row['Arr Time']) * 24 * 60;
                return sum + (stopTime > 10 ? stopTime - 10 : 0);
            }, 0);
            score -= Math.min(delays / 2, 20);
            return Math.max(0, Math.round(score));
        }

        function getMaintenanceSuggestion(thi) {
            if (thi >= 80) return "✅ Train in excellent condition. Routine checks sufficient.";
            if (thi >= 50) return "⚠️ Schedule maintenance within 48 hours.";
            return "❌ Critical issues detected. Immediate inspection required!";
        }

        function decimalToTime(decimal) {
            if (decimal == null) return 'N/A';
            const hours = Math.floor(decimal * 24);
            const minutes = Math.round((decimal * 24 - hours) * 60);
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
        }

        // AI Features (100+ Real-Time)
        const aiFeatures = [
            // Anomaly Detection (20)
            { name: 'Negative Stop Time Detection', fn: data => data.some(row => (row['Dep Time'] - row['Arr Time']) < 0) ? "⚠️ Negative stop times detected." : "✅ No negative stop times.", description: 'Identifies invalid stop durations.' },
            { name: 'Missing Time Detection', fn: data => data.some(row => row['Arr Time'] == null || row['Dep Time'] == null) ? "⚠️ Missing arrival/departure times." : "✅ All times present.", description: 'Checks for null time entries.' },
            { name: 'Distance Anomaly', fn: data => data.some((row, i) => i > 0 && row.Distance < data[i-1].Distance) ? "⚠️ Decreasing distance detected." : "✅ Distance progression valid.", description: 'Ensures distance increases monotonically.' },
            { name: 'Station Code Duplication', fn: data => new Set(data.map(row => row['Station Code'])).size !== data.length ? "⚠️ Duplicate station codes." : "✅ Unique station codes.", description: 'Detects repeated station codes.' },
            { name: 'Sequence Gap Detection', fn: data => data.some((row, i) => i > 0 && row.SEQ !== data[i-1].SEQ + 1) ? "⚠️ Gaps in SEQ numbers." : "✅ Sequential SEQ numbers.", description: 'Checks for missing SEQ values.' },
            { name: 'Source-Destination Mismatch', fn: data => data[0]['Source Station'] !== data[0]['Station Code'] || data[data.length-1]['Destination Station'] !== data[data.length-1]['Station Code'] ? "⚠️ Source/Destination mismatch." : "✅ Valid source/destination.", description: 'Verifies source and destination stations.' },
            { name: 'Time Jump Detection', fn: data => data.some((row, i) => i > 0 && (row['Arr Time'] - data[i-1]['Dep Time']) * 24 * 60 > 120) ? "⚠️ Large time jumps between stations." : "✅ Normal time progression.", description: 'Identifies unrealistic travel times.' },
            { name: 'Sensor Spike Detection', fn: sensor => sensor["Brake Temperature (°C)"] > 110 ? "⚠️ Brake temperature spike." : "✅ Normal brake temperature.", description: 'Detects extreme brake temperature readings.' },
            { name: 'Vibration Outlier', fn: sensor => sensor["Axle Vibration (mm/s)"] > 3.5 ? "⚠️ High axle vibration." : "✅ Normal vibration levels.", description: 'Identifies excessive axle vibrations.' },
            { name: 'Wheel Wear Threshold', fn: sensor => sensor["Wheel Wear (%)"] > 85 ? "⚠️ Critical wheel wear." : "✅ Wheel wear within limits.", description: 'Checks for severe wheel degradation.' },
            { name: 'Engine Overload', fn: sensor => sensor["Engine Load (%)"] > 95 ? "⚠️ Engine overload detected." : "✅ Engine load normal.", description: 'Detects engine strain.' },
            { name: 'Battery Voltage Drop', fn: sensor => sensor["Battery Voltage (V)"] < 10.8 ? "⚠️ Low battery voltage." : "✅ Battery voltage stable.", description: 'Identifies battery issues.' },
            { name: 'Fuel Efficiency Dip', fn: sensor => sensor["Fuel Efficiency (km/L)"] < 2.5 ? "⚠️ Poor fuel efficiency." : "✅ Fuel efficiency normal.", description: 'Detects fuel consumption anomalies.' },
            { name: 'Stop Time Outlier', fn: data => data.some(row => (row['Dep Time'] - row['Arr Time']) * 24 * 60 > 30) ? "⚠️ Excessive stop times." : "✅ Normal stop durations.", description: 'Identifies unusually long stops.' },
            { name: 'Schedule Inconsistency', fn: data => data.some((row, i) => i > 0 && row['Arr Time'] < data[i-1]['Dep Time']) ? "⚠️ Schedule inconsistencies." : "✅ Consistent schedule.", description: 'Checks for time overlaps.' },
            { name: 'Station Name Mismatch', fn: data => data.some(row => row['Station Name'] === row['Source Station Name'] && row['Station Code'] !== row['Source Station']) ? "⚠️ Station name/code mismatch." : "✅ Station names consistent.", description: 'Verifies station name consistency.' },
            { name: 'Zero Distance Check', fn: data => data.some((row, i) => i > 0 && row.Distance === data[i-1].Distance) ? "⚠️ Zero distance between stations." : "✅ Valid distances.", description: 'Detects missing distance increments.' },
            { name: 'Invalid SEQ', fn: data => data.some(row => row.SEQ <= 0) ? "⚠️ Invalid SEQ numbers." : "✅ Valid SEQ numbers.", description: 'Checks for non-positive SEQ values.' },
            { name: 'Time Format Anomaly', fn: data => data.some(row => isNaN(row['Arr Time']) || isNaN(row['Dep Time'])) ? "⚠️ Invalid time formats." : "✅ Valid time formats.", description: 'Ensures numeric time values.' },
            { name: 'Route Loop Detection', fn: data => data.some((row, i) => data.slice(i+1).some(r => r['Station Code'] === row['Station Code'])) ? "⚠️ Route loops detected." : "✅ No route loops.", description: 'Identifies repeated stations.' },

            // Predictive Analytics (30)
            { name: 'Delay Prediction', fn: data => {
                const stops = data.filter(row => row['Arr Time'] != null && row['Dep Time'] != null);
                const avgStop = stops.length ? stops.reduce((sum, row) => sum + (row['Dep Time'] - row['Arr Time']) * 24 * 60, 0) / stops.length : 0;
                const delay = avgStop > 5 ? Math.round((avgStop - 5) * data.length) : 0;
                return delay > 0 ? `Predicted delay: ${delay} minutes` : "No significant delay expected.";
            }, description: 'Estimates total delay based on stop durations.' },
            { name: 'Maintenance Urgency', fn: sensor => sensor["Wheel Wear (%)"] > 80 ? "Critical maintenance needed in 24 hours." : "Maintenance not urgent.", description: 'Predicts maintenance urgency.' },
            { name: 'Crowd Density Forecast', fn: data => {
                const longStops = data.filter(row => (row['Dep Time'] - row['Arr Time']) * 24 * 60 > 10).length;
                const distance = data[data.length-1]?.Distance ?? 0;
                return longStops > 2 || distance > 500 ? "High crowd density at major stations." : "Low to moderate crowd density.";
            }, description: 'Predicts station crowding.' },
            { name: 'Fuel Consumption Forecast', fn: sensor => `Predicted fuel use: ${(100 / sensor["Fuel Efficiency (km/L)"]).toFixed(2)} L/100km`, description: 'Estimates fuel consumption.' },
            { name: 'Battery Life Prediction', fn: sensor => sensor["Battery Voltage (V)"] < 11.5 ? "Battery replacement needed soon." : "Battery life sufficient.", description: 'Predicts battery health.' },
            { name: 'Brake Failure Risk', fn: sensor => sensor["Brake Temperature (°C)"] > 100 ? "High risk of brake failure." : "Low brake failure risk.", description: 'Assesses brake reliability.' },
            { name: 'Vibration Trend Analysis', fn: sensor => sensor["Axle Vibration (mm/s)"] > sensorDataHistory["Axle Vibration (mm/s)"].slice(-2)[0] ? "Increasing vibration trend." : "Stable vibration.", description: 'Analyzes vibration trends.' },
            { name: 'Engine Stress Forecast', fn: sensor => sensor["Engine Load (%)"] > 90 ? "High engine stress expected." : "Normal engine operation.", description: 'Predicts engine stress.' },
            { name: 'Travel Time Estimate', fn: data => {
                const totalTime = (data[data.length-1]['Arr Time'] - data[0]['Dep Time']) * 24 * 60;
                return `Estimated travel time: ${Math.round(totalTime)} minutes`;
            }, description: 'Calculates total journey time.' },
            { name: 'Delay Impact Score', fn: data => {
                const delays = data.reduce((sum, row) => sum + Math.max((row['Dep Time'] - row['Arr Time']) * 24 * 60 - 5, 0), 0);
                return `Delay impact: ${Math.round(delays)} minutes`;
            }, description: 'Quantifies delay impact.' },
            { name: 'Station Congestion Risk', fn: data => data.filter(row => row['Station Code'] === data[0]['Source Station'] || row['Station Code'] === data[data.length-1]['Destination Station']).length > 1 ? "High congestion at terminals." : "Low terminal congestion.", description: 'Predicts terminal crowding.' },
            { name: 'Maintenance Cost Estimate', fn: sensor => {
                const cost = (sensor["Wheel Wear (%)"] > 70 ? 5000 : 0) + (sensor["Brake Temperature (°C)"] > 90 ? 3000 : 0);
                return `Estimated maintenance cost: ₹${cost}`;
            }, description: 'Estimates repair costs.' },
            { name: 'Route Efficiency Score', fn: data => {
                const stops = data.length;
                const distance = data[data.length-1].Distance;
                return `Route efficiency: ${(distance / stops).toFixed(1)} km/stop`;
            }, description: 'Measures route efficiency.' },
            { name: 'Passenger Load Prediction', fn: data => data[0].Distance > 300 ? "High passenger load expected." : "Moderate passenger load.", description: 'Predicts passenger volume.' },
            { name: 'Weather Impact Risk', fn: data => data.length > 10 ? "Higher weather impact risk due to long route." : "Low weather impact risk.", description: 'Assesses weather-related delays.' },
            { name: 'Train Reliability Score', fn: sensor => {
                const score = 100 - (sensor["Wheel Wear (%)"] / 2 + sensor["Engine Load (%)"] / 4);
                return `Reliability: ${Math.round(score)}%`;
            }, description: 'Calculates train reliability.' },
            { name: 'Stop Time Optimization', fn: data => {
                const longStops = data.filter(row => (row['Dep Time'] - row['Arr Time']) * 24 * 60 > 15).length;
                return longStops > 0 ? `Optimize ${longStops} stops to reduce delays.` : "Stop times optimized.";
            }, description: 'Suggests stop time reductions.' },
            { name: 'Energy Consumption Forecast', fn: sensor => `Energy use: ${(sensor["Engine Load (%)"] * 0.5).toFixed(1)} kWh/km`, description: 'Predicts energy usage.' },
            { name: 'Brake Wear Rate', fn: sensor => sensor["Brake Temperature (°C)"] > 95 ? "High brake wear rate." : "Normal brake wear.", description: 'Estimates brake degradation rate.' },
            { name: 'Axle Failure Risk', fn: sensor => sensor["Axle Vibration (mm/s)"] > 3 ? "Elevated axle failure risk." : "Low axle failure risk.", description: 'Predicts axle issues.' },
            { name: 'Route Delay Trend', fn: data => {
                const delays = data.map(row => (row['Dep Time'] - row['Arr Time']) * 24 * 60);
                return delays.slice(-1)[0] > delays[0] ? "Increasing delay trend." : "Stable delay trend.";
            }, description: 'Analyzes delay trends.' },
            { name: 'Station Dwell Time Forecast', fn: data => {
                const avgDwell = data.reduce((sum, row) => sum + (row['Dep Time'] - row['Arr Time']) * 24 * 60, 0) / data.length;
                return `Average dwell time: ${avgDwell.toFixed(1)} minutes`;
            }, description: 'Predicts station dwell times.' },
            { name: 'Maintenance Interval Prediction', fn: sensor => sensor["Wheel Wear (%)"] > 75 ? "Maintenance needed in 1000 km." : "Maintenance in 5000 km.", description: 'Predicts maintenance intervals.' },
            { name: 'Train Speed Estimate', fn: data => {
                const time = (data[data.length-1]['Arr Time'] - data[0]['Dep Time']) * 24;
                const speed = data[data.length-1].Distance / time;
                return `Average speed: ${speed.toFixed(1)} km/h`;
            }, description: 'Estimates average speed.' },
            { name: 'Route Congestion Forecast', fn: data => data.length > 15 ? "High route congestion expected." : "Low route congestion.", description: 'Predicts route crowding.' },
            { name: 'Sensor Drift Detection', fn: sensor => sensorDataHistory["Brake Temperature (°C)"].length > 5 && Math.abs(sensor["Brake Temperature (°C)"] - sensorDataHistory["Brake Temperature (°C)"][0]) > 20 ? "Sensor drift detected." : "No sensor drift.", description: 'Identifies sensor calibration issues.' },
            { name: 'Emergency Stop Risk', fn: sensor => sensor["Brake Temperature (°C)"] > 105 ? "High emergency stop risk." : "Low emergency stop risk.", description: 'Predicts emergency stop likelihood.' },
            { name: 'Passenger Comfort Score', fn: sensor => {
                const score = 100 - sensor["Axle Vibration (mm/s)"] * 10;
                return `Comfort score: ${Math.round(score)}%`;
            }, description: 'Assesses passenger comfort.' },
            { name: 'Operational Risk Index', fn: sensor => {
                const risk = sensor["Wheel Wear (%)"] / 2 + sensor["Brake Temperature (°C)"] / 5;
                return `Operational risk: ${Math.round(risk)}%`;
            }, description: 'Calculates overall risk.' },
            { name: 'Schedule Adherence Forecast', fn: data => {
                const adherence = data.filter(row => (row['Dep Time'] - row['Arr Time']) * 24 * 60 <= 5).length / data.length;
                return `Schedule adherence: ${(adherence * 100).toFixed(1)}%`;
            }, description: 'Predicts schedule reliability.' },

            // Optimization (20)
            { name: 'Schedule Optimization', fn: data => {
                const totalTime = (data[data.length-1]['Arr Time'] - data[0]['Dep Time']) * 24 * 60;
                return `Optimized travel time: ${Math.round(totalTime * 0.95)} minutes`;
            }, description: 'Suggests faster schedules.' },
            { name: 'Stop Reduction', fn: data => {
                const minorStops = data.filter(row => (row['Dep Time'] - row['Arr Time']) * 24 * 60 < 3).length;
                return minorStops > 0 ? `Reduce ${minorStops} minor stops.` : "No minor stops to reduce.";
            }, description: 'Recommends fewer stops.' },
            { name: 'Fuel Optimization', fn: sensor => sensor["Fuel Efficiency (km/L)"] < 3 ? "Adjust engine load to improve fuel efficiency." : "Fuel use optimized.", description: 'Suggests fuel-saving adjustments.' },
            { name: 'Route Shortening', fn: data => data.length > 10 ? "Consider alternative route with fewer stops." : "Route length optimal.", description: 'Proposes shorter routes.' },
            { name: 'Maintenance Scheduling', fn: sensor => sensor["Wheel Wear (%)"] > 70 ? "Schedule maintenance at next major station." : "No immediate maintenance needed.", description: 'Optimizes maintenance timing.' },
            { name: 'Energy Optimization', fn: sensor => sensor["Engine Load (%)"] > 85 ? "Reduce engine load to save energy." : "Energy use optimized.", description: 'Suggests energy-saving measures.' },
            { name: 'Brake Usage Optimization', fn: sensor => sensor["Brake Temperature (°C)"] > 90 ? "Minimize abrupt braking." : "Braking optimized.", description: 'Reduces brake wear.' },
            { name: 'Speed Optimization', fn: data => {
                const speed = data[data.length-1].Distance / ((data[data.length-1]['Arr Time'] - data[0]['Dep Time']) * 24);
                return speed < 60 ? "Increase speed to reduce travel time." : "Speed optimized.";
            }, description: 'Suggests speed adjustments.' },
            { name: 'Crowd Management', fn: data => data.filter(row => (row['Dep Time'] - row['Arr Time']) * 24 * 60 > 10).length > 2 ? "Add staff at long-stop stations." : "Crowd management sufficient.", description: 'Optimizes crowd handling.' },
            { name: 'Station Dwell Reduction', fn: data => {
                const longDwells = data.filter(row => (row['Dep Time'] - row['Arr Time']) * 24 * 60 > 8).length;
                return longDwells > 0 ? `Reduce dwell time at ${longDwells} stations.` : "Dwell times optimized.";
            }, description: 'Minimizes station dwell times.' },
            { name: 'Battery Charging Schedule', fn: sensor => sensor["Battery Voltage (V)"] < 11.5 ? "Charge battery at next stop." : "Battery charge sufficient.", description: 'Optimizes battery charging.' },
            { name: 'Sensor Calibration', fn: sensor => sensorDataHistory["Brake Temperature (°C)"].length > 5 && Math.abs(sensor["Brake Temperature (°C)"] - sensorDataHistory["Brake Temperature (°C)"][0]) > 15 ? "Recalibrate sensors." : "Sensors calibrated.", description: 'Ensures sensor accuracy.' },
            { name: 'Maintenance Cost Reduction', fn: sensor => sensor["Wheel Wear (%)"] > 70 ? "Replace wheels to avoid major repairs." : "Maintenance costs optimized.", description: 'Minimizes repair costs.' },
            { name: 'Route Redundancy Removal', fn: data => data.length > 12 ? "Eliminate redundant stops." : "No redundant stops.", description: 'Removes unnecessary stops.' },
            { name: 'Operational Efficiency', fn: data => {
                const efficiency = 100 - (data.length / data[data.length-1].Distance) * 100;
                return `Operational efficiency: ${Math.round(efficiency)}%`;
            }, description: 'Maximizes operational efficiency.' },
            { name: 'Delay Mitigation', fn: data => data.some(row => (row['Dep Time'] - row['Arr Time']) * 24 * 60 > 15) ? "Adjust schedule to mitigate delays." : "No delay mitigation needed.", description: 'Reduces delay impact.' },
            { name: 'Passenger Flow Optimization', fn: data => data[0].Distance > 400 ? "Streamline boarding at major stations." : "Passenger flow optimized.", description: 'Improves passenger movement.' },
            { name: 'Sensor Data Optimization', fn: sensor => sensorDataHistory["Axle Vibration (mm/s)"].length > 5 && sensor["Axle Vibration (mm/s)"] > 3 ? "Adjust axle alignment." : "Sensor data optimized.", description: 'Optimizes sensor readings.' },
            { name: 'Emergency Response Plan', fn: sensor => sensor["Brake Temperature (°C)"] > 100 ? "Prepare emergency response team." : "No emergency response needed.", description: 'Plans for emergencies.' },
            { name: 'Route Safety Optimization', fn: data => data.length > 10 ? "Enhance safety checks on long routes." : "Route safety optimized.", description: 'Improves route safety.' },

            // Personalization (20)
            { name: 'User Preference Learning', fn: () => {
                const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
                return prefs.favoriteTrains?.length ? `Personalized for ${prefs.favoriteTrains.length} favorite trains.` : "No preferences set.";
            }, description: 'Adapts to user preferences.' },
            { name: 'Favorite Train Alerts', fn: data => {
                const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
                return favorites.includes(data[0]['Train No'].toString()) ? "Favorite train alert enabled." : "Add to favorites for alerts.";
            }, description: 'Notifies for favorite trains.' },
            { name: 'Custom THI Thresholds', fn: sensor => {
                const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
                const threshold = prefs.thiThreshold || 80;
                return calculateTHI(sensor, []) < threshold ? `THI below your threshold of ${threshold}.` : `THI meets your threshold of ${threshold}.`;
            }, description: 'Uses user-defined THI thresholds.' },
            { name: 'Personalized Delay Alerts', fn: data => {
                const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
                const delayThreshold = prefs.delayThreshold || 10;
                const delay = aiFeatures.find(f => f.name === 'Delay Prediction').fn(data);
                return delay.includes('minutes') && parseInt(delay) > delayThreshold ? `Delay exceeds your threshold of ${delayThreshold} minutes.` : "Delay within your threshold.";
            }, description: 'Alerts based on user delay preferences.' },
            { name: 'Preferred Station Notifications', fn: data => {
                const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
                const stations = prefs.preferredStations || [];
                return data.some(row => stations.includes(row['Station Code'])) ? "Preferred stations in route." : "No preferred stations in route.";
            }, description: 'Notifies for preferred stations.' },
            { name: 'Custom Report Format', fn: () => {
                const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
                return prefs.reportFormat || "Default report format applied.";
            }, description: 'Generates reports in user-preferred format.' },
            { name: 'User Activity Tracking', fn: () => {
                const activity = JSON.parse(localStorage.getItem('userActivity') || '[]');
                return activity.length ? `Tracked ${activity.length} user actions.` : "No user activity tracked.";
            }, description: 'Monitors user interactions.' },
            { name: 'Personalized UI Theme', fn: () => {
                const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
                return prefs.theme || "Default theme applied.";
            }, description: 'Applies user-selected UI theme.' },
            { name: 'Favorite Route Suggestions', fn: data => {
                const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
                const routes = prefs.favoriteRoutes || [];
                return routes.includes(data[0]['Source Station'] + '-' + data[data.length-1]['Destination Station']) ? "Favorite route detected." : "Add route to favorites.";
            }, description: 'Suggests favorite routes.' },
            { name: 'Custom Alert Frequency', fn: () => {
                const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
                return `Alert frequency: ${prefs.alertFrequency || 'default'}`;
            }, description: 'Sets user-defined alert intervals.' },
            { name: 'Preferred Train Type', fn: data => {
                const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
                const trainType = prefs.trainType || 'All';
                return trainType === 'All' || data[0]['Train Name'].includes(trainType) ? "Matches preferred train type." : "Different train type.";
            }, description: 'Filters by preferred train types.' },
            { name: 'User Behavior Analysis', fn: () => {
                const activity = JSON.parse(localStorage.getItem('userActivity') || '[]');
                return activity.length > 5 ? "Analyzed user behavior patterns." : "Insufficient data for behavior analysis.";
            }, description: 'Analyzes user behavior.' },
            { name: 'Custom Dashboard Widgets', fn: () => {
                const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
                return prefs.widgets?.length ? `Displaying ${prefs.widgets.length} custom widgets.` : "No custom widgets set.";
            }, description: 'Shows user-selected widgets.' },
            { name: 'Personalized Maintenance Alerts', fn: sensor => {
                const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
                const maintenanceThreshold = prefs.maintenanceThreshold || 70;
                return sensor["Wheel Wear (%)"] > maintenanceThreshold ? `Maintenance alert for wheel wear above ${maintenanceThreshold}%.` : "No maintenance alerts.";
            }, description: 'Custom maintenance notifications.' },
            { name: 'User Feedback Prioritization', fn: () => {
                const feedback = JSON.parse(localStorage.getItem('userFeedback') || '[]');
                return feedback.length ? `Prioritized ${feedback.length} feedback items.` : "No feedback to prioritize.";
            }, description: 'Prioritizes user feedback.' },
            { name: 'Custom Map Settings', fn: () => {
                const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
                return prefs.mapStyle || "Default map style applied.";
            }, description: 'Applies user map preferences.' },
            { name: 'Preferred Language Support', fn: () => {
                const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
                return prefs.language || "English language applied.";
            }, description: 'Supports user-preferred language.' },
            { name: 'User Interaction Optimization', fn: () => {
                const activity = JSON.parse(localStorage.getItem('userActivity') || '[]');
                return activity.length > 10 ? "Optimized UI based on interactions." : "Default UI layout.";
            }, description: 'Optimizes UI based on user actions.' },
            { name: 'Custom Sensor Alerts', fn: sensor => {
                const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
                const sensorThreshold = prefs.sensorThreshold || 90;
                return sensor["Brake Temperature (°C)"] > sensorThreshold ? `Sensor alert: Brake temperature above ${sensorThreshold}°C.` : "No sensor alerts.";
            }, description: 'Custom sensor notifications.' },
            { name: 'Personalized Route Alerts', fn: data => {
                const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
                const distanceThreshold = prefs.distanceThreshold || 500;
                return data[data.length-1].Distance > distanceThreshold ? `Long route alert: ${data[data.length-1].Distance} km.` : "Route within threshold.";
            }, description: 'Alerts for long routes.' },

            // Sentiment and Feedback Analysis (10)
            { name: 'Feedback Sentiment Analysis', fn: message => {
                const positiveWords = ['great', 'good', 'awesome', 'excellent', 'happy'];
                const negativeWords = ['bad', 'poor', 'terrible', 'awful', 'sad'];
                message = message.toLowerCase();
                return positiveWords.some(word => message.includes(word)) ? "Positive sentiment" : negativeWords.some(word => message.includes(word)) ? "Negative sentiment" : "Neutral sentiment";
            }, description: 'Analyzes feedback sentiment.' },
            { name: 'Feedback Urgency Detection', fn: message => message.toLowerCase().includes('urgent') ? "Urgent feedback detected." : "Non-urgent feedback.", description: 'Identifies urgent feedback.' },
            { name: 'Feedback Topic Extraction', fn: message => {
                const topics = ['delay', 'maintenance', 'crowd', 'cleanliness', 'service'];
                return topics.find(topic => message.toLowerCase().includes(topic)) || "General feedback";
            }, description: 'Extracts feedback topics.' },
            { name: 'Feedback Trend Analysis', fn: () => {
                const feedback = JSON.parse(localStorage.getItem('userFeedback') || '[]');
                return feedback.length > 3 ? "Feedback trends analyzed." : "Insufficient feedback for trends.";
            }, description: 'Analyzes feedback trends.' },
            { name: 'User Satisfaction Score', fn: () => {
                const feedback = JSON.parse(localStorage.getItem('userFeedback') || '[]');
                const positive = feedback.filter(f => f.sentiment === 'Positive').length;
                return `Satisfaction: ${feedback.length ? Math.round((positive / feedback.length) * 100) : 0}%`;
            }, description: 'Calculates user satisfaction.' },
            { name: 'Feedback Actionability', fn: message => message.length > 20 ? "Actionable feedback provided." : "Feedback too brief.", description: 'Assesses feedback actionability.' },
            { name: 'Feedback Response Suggestion', fn: message => message.toLowerCase().includes('delay') ? "Suggested response: Address delay concerns." : "Generic response suggested.", description: 'Suggests feedback responses.' },
            { name: 'Feedback Sentiment Trend', fn: () => {
                const feedback = JSON.parse(localStorage.getItem('userFeedback') || '[]').slice(-5);
                return feedback.length > 2 && feedback.every(f => f.sentiment === 'Positive') ? "Positive sentiment trend." : "Mixed sentiment trend.";
            }, description: 'Tracks sentiment trends.' },
            { name: 'Feedback Volume Analysis', fn: () => {
                const feedback = JSON.parse(localStorage.getItem('userFeedback') || '[]');
                return `Feedback volume: ${feedback.length} entries`;
            }, description: 'Measures feedback volume.' },
            { name: 'Feedback Priority Scoring', fn: message => message.toLowerCase().includes('safety') ? "High priority feedback." : "Standard priority feedback.", description: 'Prioritizes safety-related feedback.' }
        ];

        function initializeAI() {
            const aiFeaturesList = document.getElementById('ai-features-list');
            aiFeatures.forEach(feature => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${feature.name}</strong>: ${feature.description}`;
                aiFeaturesList.appendChild(li);
            });
        }

        // Train schedule and THI
        const getThiBtn = document.getElementById('get-thi');
        const trainNumberInput = document.getElementById('train-number');
        const suggestionsDiv = document.getElementById('suggestions');
        const trainNotFound = document.getElementById('train-not-found');
        const trainTableBody = document.getElementById('train-table-body');
        const sensorTable = document.getElementById('sensor-table');
        const thiScoreDiv = document.getElementById('thi-score');
        const thiValue = document.getElementById('thi-value');
        const thiProgress = document.getElementById('thi-progress');
        const maintenanceSuggestion = document.getElementById('maintenance-suggestion');

        trainNumberInput.addEventListener('input', () => {
            const query = trainNumberInput.value.trim();
            if (!query) {
                suggestionsDiv.classList.add('hidden');
                return;
            }
            const uniqueTrains = [...new Set(trainData.map(row => ({ no: row['Train No'], name: row['Train Name'] })))]
                .filter(train => train.no?.toString().startsWith(query))
                .slice(0, 5);
            suggestionsDiv.innerHTML = uniqueTrains.map(train => `<div data-train="${train.no}">${train.no} - ${train.name}</div>`).join('');
            suggestionsDiv.classList.toggle('hidden', !uniqueTrains.length);
            suggestionsDiv.querySelectorAll('div').forEach(div => {
                div.addEventListener('click', () => {
                    trainNumberInput.value = div.dataset.train;
                    suggestionsDiv.classList.add('hidden');
                    getThiBtn.click();
                });
            });
        });

        getThiBtn.addEventListener('click', () => {
            const trainNo = trainNumberInput.value.trim();
            const filteredData = trainData.filter(row => row['Train No']?.toString() === trainNo);
            trainTableBody.innerHTML = '';
            trainNotFound.classList.add('hidden');
            suggestionsDiv.classList.add('hidden');

            if (!filteredData.length) {
                trainNotFound.classList.remove('hidden');
                sensorTable.innerHTML = '';
                thiScoreDiv.innerHTML = '<p class="text-lg font-bold text-gray-300">THI Score: <span id="thi-value">0</span> / 100</p><div class="progress-bar h-6 w-full mt-2"><div id="thi-progress" class="progress-bar-fill" style="width: 0%"></div></div>';
                maintenanceSuggestion.innerHTML = '';
                if (sensorChart) sensorChart.destroy();
                return;
            }

            // Display schedule
            filteredData.forEach(row => {
                const isSource = row['Station Code'] === row['Source Station'];
                const isDest = row['Station Code'] === row['Destination Station'];
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3 border border-gray-600">${row.SEQ ?? 'N/A'}</td>
                    <td class="p-3 border border-gray-600">${row['Station Name'] ?? 'Unknown'} (${row['Station Code'] ?? 'N/A'}) ${isSource ? '🛤️' : isDest ? '🏁' : ''}</td>
                    <td class="p-3 border border-gray-600">${decimalToTime(row['Arr Time'])}</td>
                    <td class="p-3 border border-gray-600">${decimalToTime(row['Dep Time'])}</td>
                    <td class="p-3 border border-gray-600">${row.Distance ?? 0} km</td>
                `;
                trainTableBody.appendChild(tr);
            });

            // Add to favorites
            const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            if (!favorites.includes(trainNo)) {
                favorites.push(trainNo);
                localStorage.setItem('favorites', JSON.stringify(favorites));
                updateFavorites();
            }

            // Initialize sensor chart
            if (sensorChart) sensorChart.destroy();
            sensorChart = new Chart(document.getElementById('sensor-chart'), {
                type: 'line',
                data: {
                    labels: timeSeries,
                    datasets: Object.keys(sensorDataHistory).map(key => ({
                        label: key,
                        data: sensorDataHistory[key],
                        borderColor: ['#3B82F6', '#22C55E', '#F97316', '#A855F7', '#EF4444', '#10B981'][Object.keys(sensorDataHistory).indexOf(key)],
                        fill: false,
                        tension: 0.3
                    }))
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: 'Time (s)', color: '#D1D5DB' }, ticks: { color: '#D1D5DB' } },
                        y: { title: { display: true, text: 'Value', color: '#D1D5DB' }, ticks: { color: '#D1D5DB' } }
                    },
                    plugins: {
                        title: { display: true, text: 'Real-Time Sensor Data', color: '#D1D5DB', font: { size: 16 } },
                        legend: { labels: { color: '#D1D5DB' } }
                    }
                }
            });

            // Start sensor updates
            timeSeries = [];
            Object.values(sensorDataHistory).forEach(arr => arr.length = 0);
            let t = 0;
            const updateInterval = setInterval(() => {
                const sensorData = generateSensorData();
                const thi = calculateTHI(sensorData, filteredData);
                timeSeries.push(t++);

                // Update sensor history
                Object.keys(sensorDataHistory).forEach(key => {
                    sensorDataHistory[key].push(sensorData[key]);
                    if (sensorDataHistory[key].length > 20) sensorDataHistory[key].shift();
                });
                if (timeSeries.length > 20) timeSeries.shift();

                // Update sensor table
                sensorTable.innerHTML = `
                    <table class="w-full border-collapse text-sm">
                        <thead><tr class="bg-blue-800 text-white"><th class="p-3">Parameter</th><th class="p-3">Value</th></tr></thead>
                        <tbody>${Object.entries(sensorData).map(([k, v]) => `<tr><td class="p-3 border border-gray-600">${k}</td><td class="p-3 border border-gray-600">${v.toFixed(2)}</td></tr>`).join('')}</tbody>
                    </table>
                `;

                // Update THI
                thiValue.textContent = thi;
                thiProgress.style.width = `${thi}%`;
                maintenanceSuggestion.innerHTML = `<p class="text-lg">${getMaintenanceSuggestion(thi)}</p>`;

                // Update chart
                sensorChart.data.labels = timeSeries;
                sensorChart.data.datasets.forEach((dataset, i) => {
                    dataset.data = sensorDataHistory[Object.keys(sensorDataHistory)[i]];
                });
                sensorChart.update();

                // Run AI features
                const aiResults = aiFeatures.map(feature => {
                    const result = feature.fn === aiFeatures.find(f => f.name === 'Feedback Sentiment Analysis').fn
                        ? "N/A (Feedback-based)"
                        : feature.fn(filteredData.length ? filteredData : sensorData);
                    return `<p class="text-sm"><strong>${feature.name}:</strong> ${result}</p>`;
                });
                maintenanceSuggestion.innerHTML += `<div class="mt-4">${aiResults.join('')}</div>`;

                if (t > 100) clearInterval(updateInterval);
            }, 5000); // Update every 5 seconds for real-time effect
        });

        // Favorites
        function updateFavorites() {
            const favoritesList = document.getElementById('favorites-list');
            const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            favoritesList.innerHTML = '';
            favorites.forEach(trainNo => {
                const train = trainData.find(row => row['Train No']?.toString() === trainNo);
                if (train) {
                    const div = document.createElement('div');
                    div.className = 'train-card glassmorphism p-4 rounded-lg';
                    div.innerHTML = `
                        <p class="font-bold text-blue-300">${trainNo} - ${train['Train Name'] || 'Unknown'}</p>
                        <p class="text-sm text-gray-400">From: ${train['Source Station Name'] || 'N/A'} (${train['Source Station']})</p>
                        <p class="text-sm text-gray-400">To: ${train['Destination Station Name'] || 'N/A'} (${train['Destination Station']})</p>
                    `;
                    favoritesList.appendChild(div);
                }
            });
        }

        // Sound toggle
        const toggleSound = document.getElementById('toggle-sound');
        const trainSound = document.getElementById('train-sound');
        let soundOn = false;
        toggleSound.addEventListener('click', () => {
            soundOn = !soundOn;
            if (soundOn) {
                trainSound.play();
                toggleSound.innerHTML = '<i class="fas fa-volume-up"></i> Sound On';
            } else {
                trainSound.pause();
                toggleSound.innerHTML = '<i class="fas fa-volume-mute"></i> Sound Off';
            }
        });

        // Route map
        const map = L.map('route-map').setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        getThiBtn.addEventListener('click', () => {
            const trainNo = trainNumberInput.value.trim();
            const filteredData = trainData.filter(row => row['Train No']?.toString() === trainNo);
            map.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) map.removeLayer(layer);
            });
            if (filteredData.length) {
                filteredData.forEach((row, index) => {
                    const lat = 20 + index * 0.1; // Mock coordinates
                    const lon = 78 + index * 0.1;
                    L.marker([lat, lon]).addTo(map).bindPopup(`${row['Station Name'] || 'Unknown'} (${row['Station Code']})`);
                    if (index > 0) {
                        L.polyline([[lat - 0.1, lon - 0.1], [lat, lon]], { color: '#3B82F6' }).addTo(map);
                    }
                });
                map.fitBounds(filteredData.map((_, i) => [20 + i * 0.1, 78 + i * 0.1]));
            }
        });

        // Contact form with sentiment analysis
        document.getElementById('contact-submit').addEventListener('click', () => {
            const message = document.getElementById('contact-message').value;
            if (message) {
                const sentiment = aiFeatures.find(f => f.name === 'Feedback Sentiment Analysis').fn(message);
                const feedback = JSON.parse(localStorage.getItem('userFeedback') || '[]');
                feedback.push({ message, sentiment, timestamp: new Date().toISOString() });
                localStorage.setItem('userFeedback', JSON.stringify(feedback));
                document.getElementById('sentiment-analysis').innerHTML = `Sentiment: ${sentiment}`;
                alert('Feedback sent!');
                document.getElementById('contact-message').value = '';
            } else {
                alert('Please enter a message.');
            }
        });

        // AI features modal
        const showAiFeatures = document.getElementById('show-ai-features');
        const aiFeaturesModal = document.getElementById('ai-features-modal');
        const closeAiModal = document.getElementById('close-ai-modal');

        showAiFeatures.addEventListener('click', () => {
            aiFeaturesModal.style.display = 'flex';
        });

        closeAiModal.addEventListener('click', () => {
            aiFeaturesModal.style.display = 'none';
        });

        // Export report
        document.getElementById('export-report').addEventListener('click', () => {
            const trainNo = trainNumberInput.value.trim();
            const filteredData = trainData.filter(row => row['Train No']?.toString() === trainNo);
            if (!filteredData.length) {
                alert('Please select a train first.');
                return;
            }
            const report = {
                trainNo,
                trainName: filteredData[0]['Train Name'],
                schedule: filteredData.map(row => ({
                    station: row['Station Name'],
                    code: row['Station Code'],
                    arrival: decimalToTime(row['Arr Time']),
                    departure: decimalToTime(row['Dep Time']),
                    distance: row.Distance
                })),
                thi: document.getElementById('thi-value').textContent,
                maintenance: maintenanceSuggestion.textContent,
                aiInsights: aiFeatures.map(f => ({ name: f.name, result: f.fn(filteredData.length ? filteredData : generateSensorData()) }))
            };
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `train_${trainNo}_report.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // User preferences
        function updateUserPreferences(username) {
            const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
            prefs.username = username;
            prefs.favoriteTrains = JSON.parse(localStorage.getItem('favorites') || '[]');
            prefs.lastLogin = new Date().toISOString();
            localStorage.setItem('userPrefs', JSON.stringify(prefs));
        }

        // Initialize
        fetchTrainData().then(updateFavorites);
    </script>
</body>
</html>
