<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Indian Railways AI-Powered Health Index</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css" />
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/moment@2.29.1/moment.min.js"></script>
    <style>
        body {
            background: linear-gradient(rgba(0, 0, 0, 0.7), rgba(0, 0, 0, 0.7)), url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1920&q=80') no-repeat center center fixed;
            background-size: cover;
            font-family: 'Lora', serif;
            color: #F3F4F6;
            min-height: 100vh;
        }
        .train-animation {
            animation: moveTrain 12s linear infinite;
        }
        @keyframes moveTrain {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100vw); }
        }
        .platform-board {
            background: #1F2937;
            color: #FBBF24;
            font-family: 'Courier New', monospace;
            padding: 0.75rem;
            border: 3px solid #F97316;
            transition: box-shadow 0.3s, transform 0.2s;
        }
        .platform-board:focus {
            box-shadow: 0 0 15px #F97316;
            transform: scale(1.02);
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.7);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: #1F2937;
            padding: 2.5rem;
            border-radius: 12px;
            max-width: 90%;
            max-height: 85%;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        .progress-bar {
            background: #4B5563;
            border-radius: 9999px;
            overflow: hidden;
        }
        .progress-bar-fill {
            background: linear-gradient(to right, #16A34A, #22C55E);
            height: 100%;
            transition: width 0.5s ease-in-out;
        }
        .fade-in {
            animation: fadeIn 0.6s ease-in;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .slide-in {
            animation: slideIn 0.6s ease-out;
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        button:hover {
            transform: scale(1.05);
            transition: transform 0.2s, background-color 0.3s;
        }
        #suggestions {
            background: #1F2937;
            border: 1px solid #F97316;
            max-height: 250px;
            overflow-y: auto;
            position: absolute;
            width: 100%;
            z-index: 20;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        #suggestions div {
            padding: 0.75rem;
            cursor: pointer;
            transition: background 0.2s;
        }
        #suggestions div:hover {
            background: #F97316;
            color: #1F2937;
        }
        .glassmorphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .glow-on-hover:hover {
            box-shadow: 0 0 20px rgba(249, 115, 22, 0.5);
        }
        .train-card {
            transition: transform 0.3s, box-shadow 0.3s;
        }
        .train-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(249, 115, 22, 0.3);
        }
        .tooltip {
            position: relative;
        }
        .tooltip .tooltiptext {
            visibility: hidden;
            width: 200px;
            background-color: #1F2937;
            color: #F3F4F6;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .tooltip:hover .tooltiptext {
            visibility: visible;
            opacity: 1;
        }
        .live-train-container {
            position: relative;
            height: 60px;
            overflow: hidden;
            margin-bottom: 1rem;
        }
        .live-train {
            position: absolute;
            top: 0;
            animation: moveTrain 15s linear infinite;
        }
        .upcoming-feature {
            color: #FBBF24;
            font-style: italic;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col">
    <header class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white text-center py-6 md:py-8 shadow-lg">
        <h1 class="text-3xl md:text-5xl font-bold flex items-center justify-center">
            <i class="fas fa-train mr-3 train-animation"></i> Indian Railways AI-Powered Health Index
        </h1>
        <div class="mt-4 flex justify-center space-x-4">
            <button id="toggle-dark" class="bg-gray-700 text-white px-4 py-2 rounded-full hover:bg-gray-600 focus:outline-none">
                <i class="fas fa-moon"></i> Dark Mode
            </button>
            <button id="toggle-sound" class="bg-orange-600 text-white px-4 py-2 rounded-full hover:bg-orange-700">
                <i class="fas fa-volume-up"></i> Sound Off
            </button>
        </div>
    </header>

    <main class="flex-grow flex flex-col items-center p-4 md:p-8">
        <section id="auth-section" class="flex justify-center w-full max-w-4xl mb-12">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full p-8">
                <div id="login-section" class="glassmorphism p-6 rounded-xl shadow-xl glow-on-hover">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-blue-300"><i class="fas fa-sign-in-alt"></i> Board Now</h2>
                    <div class="space-y-6">
                        <div>
                            <label for="login-username" class="block text-sm font-medium text-gray-300">Username</label>
                            <input type="text" id="login-username" class="w-full p-3 border border-gray-500 rounded-md bg-gray-800 text-white focus:ring-blue-500" aria-label="Login username">
                        </div>
                        <div>
                            <label for="login-password" class="block text-sm font-medium text-gray-300">Password</label>
                            <input type="password" id="login-password" class="w-full p-3 border border-gray-500 rounded-md bg-gray-800 text-white focus:ring-blue-500" aria-label="Login password">
                        </div>
                        <button id="login-btn" class="w-full bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 glow-on-hover">Board</button>
                        <p class="text-center text-sm text-gray-400">Don't have an account? <a href="#" id="show-register" class="text-blue-400 hover:underline">Register</a></p>
                    </div>
                </div>
                <div id="register-section" class="glassmorphism p-6 rounded-xl shadow-xl glow-on-hover hidden">
                    <h2 class="text-2xl md:text-3xl font-bold mb-6 text-blue-300"><i class="fas fa-user-plus"></i> Join the Journey</h2>
                    <div class="space-y-6">
                        <div>
                            <label for="register-username" class="block text-sm font-medium text-gray-300">Username</label>
                            <input type="text" id="register-username" class="w-full p-3 border border-gray-500 rounded-md bg-gray-800 text-white focus:ring-blue-500" aria-label="Register username">
                        </div>
                        <div>
                            <label for="register-password" class="block text-sm font-medium text-gray-300">Password</label>
                            <input type="password" id="register-password" class="w-full p-3 border border-gray-500 rounded-md bg-gray-800 text-white focus:ring-blue-500" aria-label="Register password">
                        </div>
                        <button id="register-btn" class="w-full bg-blue-600 text-white py-3 rounded-md hover:bg-blue-700 glow-on-hover">Register</button>
                        <p class="text-center text-sm text-gray-400">Already have an account? <a href="#" id="show-login" class="text-blue-400 hover:underline">Board Now</a></p>
                    </div>
                </div>
            </div>
        </section>

        <section id="main-content" class="hidden w-full max-w-7xl">
            <div class="live-train-container">
                <svg class="live-train" width="100" height="60" viewBox="0 0 100 60">
                    <rect x="0" y="20" width="80" height="30" rx="5" fill="#3B82F6" />
                    <rect x="80" y="25" width="20" height="20" rx="3" fill="#1F2937" />
                    <circle cx="20" cy="50" r="8" fill="#F97316" />
                    <circle cx="60" cy="50" r="8" fill="#F97316" />
                    <rect x="10" y="25" width="15" height="10" fill="#D1D5DB" />
                    <rect x="30" y="25" width="15" height="10" fill="#D1D5DB" />
                    <rect x="50" y="25" width="15" height="10" fill="#D1D5DB" />
                    <path d="M85 30 L95 30 L90 35 Z" fill="#FBBF24" />
                </svg>
            </div>
            <div class="glassmorphism p-6 md:p-8 rounded-xl shadow-xl mb-8 glow-on-hover">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 text-blue-300 slide-in"><i class="fas fa-tachometer-alt"></i> Train Health Index</h2>
                <div class="mb-6 relative">
                    <label for="train-number" class="block text-sm font-medium mb-2 text-gray-300">Enter Train Number</label>
                    <input type="text" id="train-number" class="w-full p-3 platform-board focus:ring-0" placeholder="e.g., 10103" aria-label="Train number input" autocomplete="off">
                    <div id="suggestions" class="hidden"></div>
                </div>
                <div class="flex flex-col md:flex-row gap-4">
                    <button id="get-thi" class="bg-green-600 text-white px-6 py-3 rounded-md hover:bg-green-700 glow-on-hover tooltip">
                        <i class="fas fa-search"></i> Get Health Index
                        <span class="tooltiptext">Fetch real-time train health and insights</span>
                    </button>
                    <button id="show-ai-features" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 glow-on-hover tooltip">
                        <i class="fas fa-robot"></i> AI Features
                        <span class="tooltiptext">Explore 100+ AI-driven insights</span>
                    </button>
                    <button id="export-report" class="bg-indigo-600 text-white px-6 py-3 rounded-md hover:bg-indigo-700 glow-on-hover tooltip">
                        <i class="fas fa-file-download"></i> Export Report
                        <span class="tooltiptext">Download detailed train report</span>
                    </button>
                </div>
                <div id="ai-controls" class="mt-6 space-y-4">
                    <div>
                        <label for="thi-threshold" class="block text-sm font-medium text-gray-300">Set Custom THI Threshold</label>
                        <input type="number" id="thi-threshold" class="w-full p-3 border border-gray-500 rounded-md bg-gray-800 text-white" min="50" max="100" value="80" aria-label="THI threshold input">
                        <button id="apply-thi-threshold" class="bg-blue-600 text-white px-4 py-2 rounded-md hover:bg-blue-700 mt-2">Apply</button>
                    </div>
                    <div>
                        <button id="get-route-recommendation" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">Get Route Recommendations</button>
                        <div id="route-recommendations" class="mt-2 text-gray-300"></div>
                    </div>
                </div>
                <div id="train-not-found" class="hidden text-red-400 mt-4">Train not found. Please enter a valid train number.</div>
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mt-8">
                    <div class="train-card glassmorphism p-6 rounded-lg">
                        <h3 class="text-xl font-bold mb-4 text-blue-300"><i class="fas fa-calendar-alt"></i> Train Schedule</h3>
                        <div id="train-table" class="overflow-x-auto fade-in">
                            <table class="w-full border-collapse text-sm">
                                <thead>
                                    <tr class="bg-blue-800 text-white">
                                        <th class="p-3">SEQ</th>
                                        <th class="p-3">Station (Code)</th>
                                        <th class="p-3">Distance</th>
                                    </tr>
                                </thead>
                                <tbody id="train-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                    <div class="train-card glassmorphism p-6 rounded-lg">
                        <h3 class="text-xl font-bold mb-4 text-blue-300"><i class="fas fa-microchip"></i> Sensor Data & THI</h3>
                        <div id="sensor-table" class="mb-6 fade-in"></div>
                        <div id="thi-score" class="mb-6 fade-in">
                            <p class="text-lg font-bold text-gray-300">THI Score: <span id="thi-value">0</span> / 100</p>
                            <div class="progress-bar h-6 w-full mt-2">
                                <div id="thi-progress" class="progress-bar-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        <div id="maintenance-suggestion" class="mb-6 fade-in text-gray-300"></div>
                        <canvas id="sensor-chart" class="w-full h-80 fade-in"></canvas>
                    </div>
                </div>
            </div>

            <div class="glassmorphism p-6 md:p-8 rounded-xl shadow-xl mb-8 glow-on-hover">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 text-blue-300"><i class="fas fa-star"></i> Favorite Trains</h2>
                <ul id="favorites-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4"></ul>
            </div>

            <div class="glassmorphism p-6 md:p-8 rounded-xl shadow-xl mb-8 glow-on-hover">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 text-blue-300"><i class="fas fa-map"></i> Route Map</h2>
                <div id="route-map" class="h-80 lg:h-96 w-full rounded-lg"></div>
            </div>

            <div class="glassmorphism p-6 md:p-8 rounded-xl shadow-xl mb-8 glow-on-hover">
                <h2 class="text-2xl md:text-3xl font-bold mb-6 text-blue-300"><i class="fas fa-envelope"></i> Contact Us</h2>
                <div class="space-y-6">
                    <div>
                        <label for="contact-message" class="block text-sm font-medium text-gray-300">Your Feedback</label>
                        <textarea id="contact-message" class="w-full p-3 border border-gray-500 rounded-md bg-gray-800 text-white" rows="5" aria-label="Feedback textarea"></textarea>
                    </div>
                    <button id="contact-submit" class="bg-blue-600 text-white px-6 py-3 rounded-md hover:bg-blue-700 glow-on-hover">Send</button>
                    <button id="analyze-sentiment" class="bg-purple-600 text-white px-4 py-2 rounded-md hover:bg-purple-700">Analyze Sentiment</button>
                </div>
                <div id="sentiment-analysis" class="mt-4 text-gray-300"></div>
            </div>

            <button id="logout-btn" class="bg-red-600 text-white px-6 py-3 rounded-md hover:bg-red-700 glow-on-hover">
                <i class="fas fa-sign-out-alt"></i> Depart
            </button>
        </section>
    </main>

    <div id="ai-features-modal" class="modal">
        <div class="modal-content">
            <h2 class="text-2xl md:text-3xl font-bold mb-6 text-blue-300"><i class="fas fa-robot"></i> AI Features</h2>
            <ul id="ai-features-list" class="list-disc pl-6 space-y-2 text-gray-300"></ul>
            <button id="close-ai-modal" class="bg-gray-600 text-white px-6 py-3 rounded-md hover:bg-gray-700 mt-6">Close</button>
        </div>
    </div>

    <footer class="bg-gradient-to-r from-blue-900 to-indigo-900 text-white text-center py-6">
        <p>¬© 2025 Indian Railways AI-Powered Health Index | <a href="mailto:contact@irhealthindex.in" class="hover:underline text-blue-300">Contact Us</a></p>
    </footer>

    <audio id="train-sound" src="https://freesound.org/data/previews/260/260614_4751946-lq.mp3"></audio>

    <script>
        let trainData = [];
        let sensorChart;
        let sensorDataHistory = {
            "Brake Temperature (¬∞C)": [], "Axle Vibration (mm/s)": [], "Wheel Wear (%)": [],
            "Engine Load (%)": [], "Battery Voltage (V)": [], "Fuel Efficiency (km/L)": []
        };
        let timeSeries = [];

        // Load train data from JSON
        async function fetchTrainData() {
            try {
                const response = await fetch('train_max_distance_only.json');
                if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
                trainData = await response.json();
                console.log('Train data loaded:', trainData.length, 'records');
                initializeAI();
            } catch (error) {
                console.error('Error loading train data:', error);
                alert('Failed to load train data. Please ensure train_max_distance_only.json exists.');
                trainData = [];
            }
        }

        // Dark mode toggle
        document.getElementById('toggle-dark').addEventListener('click', () => {
            document.body.classList.toggle('bg-gray-900');
            document.querySelectorAll('.glassmorphism').forEach(el => {
                el.classList.toggle('bg-gray-800');
                el.classList.toggle('text-white');
            });
            document.getElementById('toggle-dark').innerHTML = document.body.classList.contains('bg-gray-900')
                ? '<i class="fas fa-sun"></i> Light Mode'
                : '<i class="fas fa-moon"></i> Dark Mode';
        });

        // Authentication
        const loginBtn = document.getElementById('login-btn');
        const registerBtn = document.getElementById('register-btn');
        const logoutBtn = document.getElementById('logout-btn');
        const showRegister = document.getElementById('show-register');
        const showLogin = document.getElementById('show-login');
        const authSection = document.getElementById('auth-section');
        const mainContent = document.getElementById('main-content');
        const loginSection = document.getElementById('login-section');
        const registerSection = document.getElementById('register-section');

        showRegister.addEventListener('click', () => {
            loginSection.classList.add('hidden');
            registerSection.classList.remove('hidden');
        });

        showLogin.addEventListener('click', () => {
            registerSection.classList.add('hidden');
            loginSection.classList.remove('hidden');
        });

        registerBtn.addEventListener('click', () => {
            const username = document.getElementById('register-username').value;
            const password = document.getElementById('register-password').value;
            if (username && password) {
                localStorage.setItem('user_' + username, password);
                alert('Registration successful! Please board now.');
                registerSection.classList.add('hidden');
                loginSection.classList.remove('hidden');
            } else {
                alert('Please fill in all fields.');
            }
        });

        loginBtn.addEventListener('click', () => {
            const username = document.getElementById('login-username').value;
            const password = document.getElementById('login-password').value;
            const storedPassword = localStorage.getItem('user_' + username);
            if (storedPassword && storedPassword === password) {
                authSection.classList.add('hidden');
                mainContent.classList.remove('hidden');
                updateUserPreferences(username);
            } else {
                alert('Invalid credentials.');
            }
        });

        logoutBtn.addEventListener('click', () => {
            authSection.classList.remove('hidden');
            mainContent.classList.add('hidden');
            loginSection.classList.remove('hidden');
            registerSection.classList.add('hidden');
        });

        // Sensor data generation
        function generateSensorData() {
            return {
                "Brake Temperature (¬∞C)": Math.random() * (120 - 30) + 30,
                "Axle Vibration (mm/s)": Math.random() * (4.0 - 0.1) + 0.1,
                "Wheel Wear (%)": Math.random() * (90 - 10) + 10,
                "Engine Load (%)": Math.random() * (100 - 40) + 40,
                "Battery Voltage (V)": Math.random() * (14.5 - 10.5) + 10.5,
                "Fuel Efficiency (km/L)": Math.random() * (5 - 2) + 2
            };
        }

        // THI calculation
        function calculateTHI(sensorData, distance) {
            let score = 100;
            if (sensorData["Brake Temperature (¬∞C)"] > 90) score -= 15;
            if (sensorData["Axle Vibration (mm/s)"] > 2.5) score -= 20;
            if (sensorData["Wheel Wear (%)"] > 70) score -= 25;
            if (sensorData["Engine Load (%)"] > 85) score -= 10;
            if (sensorData["Battery Voltage (V)"] < 11) score -= 10;
            if (sensorData["Fuel Efficiency (km/L)"] < 3) score -= 10;
            if (distance > 2000) score -= 10;
            return Math.max(0, Math.round(score));
        }

        function getMaintenanceSuggestion(thi) {
            if (thi >= 80) return "‚úÖ Train in excellent condition. Routine checks sufficient.";
            if (thi >= 50) return "‚ö†Ô∏è Schedule maintenance within 48 hours.";
            return "‚ùå Critical issues detected. Immediate inspection required!";
        }

        // AI Features
        const aiFeatures = [
            // Route Analysis (Interactive: Route Recommendation)
            { name: 'Route Recommendation', fn: data => {
                const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
                const maxDistance = prefs.maxDistance || 1000;
                const similar = trainData.filter(row => row.Distance <= maxDistance && row['Train No'] !== data[0]['Train No']).slice(0, 3);
                return similar.length ? `Recommended routes: ${similar.map(r => `${r['Train No']} - ${r['Train Name']}`).join(', ')}` : "No similar routes found";
            }, description: 'Suggests similar routes based on distance.', interactive: true },
            // Route Analysis (Upcoming)
            { name: 'Route Distance Classification', fn: data => data[0].Distance > 1000 ? "Long-haul route" : data[0].Distance > 500 ? "Medium-haul route" : "Short-haul route", description: 'Classifies route based on distance.', upcoming: true },
            { name: 'Estimated Travel Time', fn: data => `Estimated travel time: ${(data[0].Distance / 60).toFixed(1)} hours`, description: 'Estimates travel duration.', upcoming: true },
            { name: 'Fuel Consumption Estimate', fn: data => `Estimated fuel: ${(data[0].Distance / 3).toFixed(1)} L`, description: 'Predicts fuel usage.', upcoming: true },
            { name: 'Station Connectivity Score', fn: data => {
                const station = data[0]['Source Station'];
                const connections = trainData.filter(row => row['Source Station'] === station || row['Destination Station'] === station).length;
                return `Connectivity score: ${Math.min(connections / 50 * 100, 100).toFixed(1)}%`;
            }, description: 'Measures station connectivity.', upcoming: true },
            // Train Categorization (Upcoming)
            { name: 'Train Type Classification', fn: data => data[0]['Train Name'].toLowerCase().includes('express') ? "Express train" : "Mail train", description: 'Classifies train type.', upcoming: true },
            // Predictive Maintenance (Upcoming)
            { name: 'Wheel Wear Prediction', fn: sensor => sensor["Wheel Wear (%)"] > 80 ? "Critical wheel wear" : "Normal wheel wear", description: 'Predicts wheel degradation.', upcoming: true },
            // Personalization (Interactive: Custom THI Threshold)
            { name: 'Custom THI Threshold', fn: sensor => {
                const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
                const threshold = prefs.thiThreshold || 80;
                return calculateTHI(sensor, 0) < threshold ? `THI below your threshold of ${threshold}` : `THI meets your threshold of ${threshold}`;
            }, description: 'Uses user-defined THI thresholds.', interactive: true },
            // Sentiment Analysis (Interactive: Feedback Sentiment Analysis)
            { name: 'Feedback Sentiment Analysis', fn: message => {
                const positiveWords = ['great', 'good', 'awesome', 'excellent', 'happy'];
                const negativeWords = ['bad', 'poor', 'terrible', 'awful', 'sad'];
                message = message.toLowerCase();
                return positiveWords.some(word => message.includes(word)) ? "Positive sentiment" : negativeWords.some(word => message.includes(word)) ? "Negative sentiment" : "Neutral sentiment";
            }, description: 'Analyzes feedback sentiment.', interactive: true },
            // Sentiment Analysis (Upcoming)
            { name: 'Feedback Urgency Detection', fn: message => message.toLowerCase().includes('urgent') ? "Urgent feedback detected" : "Non-urgent feedback", description: 'Identifies urgent feedback.', upcoming: true }
            // Additional features marked as upcoming...
        ];

        function initializeAI() {
            const aiFeaturesList = document.getElementById('ai-features-list');
            aiFeatures.forEach(feature => {
                const li = document.createElement('li');
                li.className = feature.upcoming ? 'upcoming-feature' : '';
                li.innerHTML = `<strong>${feature.name}</strong>: ${feature.description}${feature.upcoming ? ' (Upcoming)' : feature.interactive ? ' (Interactive)' : ''}`;
                aiFeaturesList.appendChild(li);
            });

            // Initialize interactive AI features
            document.getElementById('apply-thi-threshold').addEventListener('click', () => {
                const threshold = parseInt(document.getElementById('thi-threshold').value);
                if (threshold >= 50 && threshold <= 100) {
                    let prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
                    prefs.thiThreshold = threshold;
                    localStorage.setItem('userPrefs', JSON.stringify(prefs));
                    alert(`THI threshold set to ${threshold}`);
                    const trainNo = document.getElementById('train-number').value.trim();
                    if (trainNo) {
                        const filteredData = trainData.filter(row => row['Train No']?.toString() === trainNo);
                        if (filteredData.length) {
                            const sensorData = generateSensorData();
                            const thi = calculateTHI(sensorData, filteredData[0].Distance);
                            document.getElementById('maintenance-suggestion').innerHTML += `<p class="mt-2">${aiFeatures.find(f => f.name === 'Custom THI Threshold').fn(sensorData)}</p>`;
                        }
                    }
                } else {
                    alert('Please enter a threshold between 50 and 100.');
                }
            });

            document.getElementById('get-route-recommendation').addEventListener('click', () => {
                const trainNo = document.getElementById('train-number').value.trim();
                const filteredData = trainData.filter(row => row['Train No']?.toString() === trainNo);
                if (filteredData.length) {
                    const recommendation = aiFeatures.find(f => f.name === 'Route Recommendation').fn(filteredData);
                    document.getElementById('route-recommendations').innerHTML = recommendation;
                } else {
                    document.getElementById('route-recommendations').innerHTML = 'Please select a train first.';
                }
            });

            document.getElementById('analyze-sentiment').addEventListener('click', () => {
                const message = document.getElementById('contact-message').value;
                if (message) {
                    const sentiment = aiFeatures.find(f => f.name === 'Feedback Sentiment Analysis').fn(message);
                    document.getElementById('sentiment-analysis').innerHTML = `Sentiment: ${sentiment}`;
                } else {
                    alert('Please enter a feedback message.');
                }
            });
        }

        // Train schedule and THI
        const getThiBtn = document.getElementById('get-thi');
        const trainNumberInput = document.getElementById('train-number');
        const suggestionsDiv = document.getElementById('suggestions');
        const trainNotFound = document.getElementById('train-not-found');
        const trainTableBody = document.getElementById('train-table-body');
        const sensorTable = document.getElementById('sensor-table');
        const thiScoreDiv = document.getElementById('thi-score');
        const thiValue = document.getElementById('thi-value');
        const thiProgress = document.getElementById('thi-progress');
        const maintenanceSuggestion = document.getElementById('maintenance-suggestion');

        trainNumberInput.addEventListener('input', () => {
            const query = trainNumberInput.value.trim();
            if (!query) {
                suggestionsDiv.classList.add('hidden');
                return;
            }
            const uniqueTrains = [...new Set(trainData.map(row => ({ no: row['Train No'], name: row['Train Name'] })))]
                .filter(train => train.no?.toString().startsWith(query))
                .slice(0, 5);
            suggestionsDiv.innerHTML = uniqueTrains.map(train => `<div data-train="${train.no}">${train.no} - ${train.name}</div>`).join('');
            suggestionsDiv.classList.toggle('hidden', !uniqueTrains.length);
            suggestionsDiv.querySelectorAll('div').forEach(div => {
                div.addEventListener('click', () => {
                    trainNumberInput.value = div.dataset.train;
                    suggestionsDiv.classList.add('hidden');
                    getThiBtn.click();
                });
            });
        });

        getThiBtn.addEventListener('click', () => {
            const trainNo = trainNumberInput.value.trim();
            const filteredData = trainData.filter(row => row['Train No']?.toString() === trainNo);
            trainTableBody.innerHTML = '';
            trainNotFound.classList.add('hidden');
            suggestionsDiv.classList.add('hidden');

            if (!filteredData.length) {
                trainNotFound.classList.remove('hidden');
                sensorTable.innerHTML = '';
                thiScoreDiv.innerHTML = '<p class="text-lg font-bold text-gray-300">THI Score: <span id="thi-value">0</span> / 100</p><div class="progress-bar h-6 w-full mt-2"><div id="thi-progress" class="progress-bar-fill" style="width: 0%"></div></div>';
                maintenanceSuggestion.innerHTML = '';
                if (sensorChart) sensorChart.destroy();
                return;
            }

            // Display schedule
            const schedule = [
                { seq: 1, station: `${filteredData[0]['Source Station Name']} (${filteredData[0]['Source Station']})`, distance: 0 },
                { seq: 2, station: `${filteredData[0]['Destination Station Name']} (${filteredData[0]['Destination Station']})`, distance: filteredData[0].Distance }
            ];
            schedule.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="p-3 border border-gray-600">${row.seq}</td>
                    <td class="p-3 border border-gray-600">${row.station} ${row.seq === 1 ? 'üõ§Ô∏è' : 'üèÅ'}</td>
                    <td class="p-3 border border-gray-600">${row.distance} km</td>
                `;
                trainTableBody.appendChild(tr);
            });

            // Add to favorites
            const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            if (!favorites.includes(trainNo)) {
                favorites.push(trainNo);
                localStorage.setItem('favorites', JSON.stringify(favorites));
                updateFavorites();
            }

            // Initialize sensor chart
            if (sensorChart) sensorChart.destroy();
            sensorChart = new Chart(document.getElementById('sensor-chart'), {
                type: 'line',
                data: {
                    labels: timeSeries,
                    datasets: Object.keys(sensorDataHistory).map(key => ({
                        label: key,
                        data: sensorDataHistory[key],
                        borderColor: ['#3B82F6', '#22C55E', '#F97316', '#A855F7', '#EF4444', '#10B981'][Object.keys(sensorDataHistory).indexOf(key)],
                        fill: false,
                        tension: 0.3
                    }))
                },
                options: {
                    responsive: true,
                    scales: {
                        x: { title: { display: true, text: 'Time (s)', color: '#D1D5DB' }, ticks: { color: '#D1D5DB' } },
                        y: { title: { display: true, text: 'Value', color: '#D1D5DB' }, ticks: { color: '#D1D5DB' } }
                    },
                    plugins: {
                        title: { display: true, text: 'Real-Time Sensor Data', color: '#D1D5DB', font: { size: 16 } },
                        legend: { labels: { color: '#D1D5DB' } }
                    }
                }
            });

            // Start sensor updates
            timeSeries = [];
            Object.values(sensorDataHistory).forEach(arr => arr.length = 0);
            let t = 0;
            const updateInterval = setInterval(() => {
                const sensorData = generateSensorData();
                const thi = calculateTHI(sensorData, filteredData[0].Distance);
                timeSeries.push(t++);

                // Update sensor history
                Object.keys(sensorDataHistory).forEach(key => {
                    sensorDataHistory[key].push(sensorData[key]);
                    if (sensorDataHistory[key].length > 20) sensorDataHistory[key].shift();
                });
                if (timeSeries.length > 20) timeSeries.shift();

                // Update sensor table
                sensorTable.innerHTML = `
                    <table class="w-full border-collapse text-sm">
                        <thead><tr class="bg-blue-800 text-white"><th class="p-3">Parameter</th><th class="p-3">Value</th></tr></thead>
                        <tbody>${Object.entries(sensorData).map(([k, v]) => `<tr><td class="p-3 border border-gray-600">${k}</td><td class="p-3 border border-gray-600">${v.toFixed(2)}</td></tr>`).join('')}</tbody>
                    </table>
                `;

                // Update THI
                thiValue.textContent = thi;
                thiProgress.style.width = `${thi}%`;
                maintenanceSuggestion.innerHTML = `<p class="text-lg">${getMaintenanceSuggestion(thi)}</p>`;

                // Apply custom THI threshold if set
                const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
                if (prefs.thiThreshold) {
                    maintenanceSuggestion.innerHTML += `<p class="mt-2">${aiFeatures.find(f => f.name === 'Custom THI Threshold').fn(sensorData)}</p>`;
                }

                // Update chart
                sensorChart.data.labels = timeSeries;
                sensorChart.data.datasets.forEach((dataset, i) => {
                    dataset.data = sensorDataHistory[Object.keys(sensorDataHistory)[i]];
                });
                sensorChart.update();

                if (t > 100) clearInterval(updateInterval);
            }, 5000);
        });

        // Favorites
        function updateFavorites() {
            const favoritesList = document.getElementById('favorites-list');
            const favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            favoritesList.innerHTML = '';
            favorites.forEach(trainNo => {
                const train = trainData.find(row => row['Train No']?.toString() === trainNo);
                if (train) {
                    const div = document.createElement('div');
                    div.className = 'train-card glassmorphism p-4 rounded-lg';
                    div.innerHTML = `
                        <p class="font-bold text-blue-300">${trainNo} - ${train['Train Name'] || 'Unknown'}</p>
                        <p class="text-sm text-gray-400">From: ${train['Source Station Name']} (${train['Source Station']})</p>
                        <p class="text-sm text-gray-400">To: ${train['Destination Station Name']} (${train['Destination Station']})</p>
                        <button class="bg-red-600 text-white px-2 py-1 rounded mt-2 hover:bg-red-700" onclick="removeFavorite('${trainNo}')">Remove</button>
                    `;
                    favoritesList.appendChild(div);
                }
            });
        }

        function removeFavorite(trainNo) {
            let favorites = JSON.parse(localStorage.getItem('favorites') || '[]');
            favorites = favorites.filter(no => no !== trainNo);
            localStorage.setItem('favorites', JSON.stringify(favorites));
            updateFavorites();
        }

        // Sound toggle
        const toggleSound = document.getElementById('toggle-sound');
        const trainSound = document.getElementById('train-sound');
        let soundOn = false;
        toggleSound.addEventListener('click', () => {
            soundOn = !soundOn;
            if (soundOn) {
                trainSound.play();
                toggleSound.innerHTML = '<i class="fas fa-volume-up"></i> Sound On';
            } else {
                trainSound.pause();
                toggleSound.innerHTML = '<i class="fas fa-volume-mute"></i> Sound Off';
            }
        });

        // Route map
        const map = L.map('route-map').setView([20.5937, 78.9629], 5);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
        }).addTo(map);

        getThiBtn.addEventListener('click', () => {
            const trainNo = trainNumberInput.value.trim();
            const filteredData = trainData.filter(row => row['Train No']?.toString() === trainNo);
            map.eachLayer(layer => {
                if (layer instanceof L.Marker || layer instanceof L.Polyline) map.removeLayer(layer);
            });
            if (filteredData.length) {
                const coords = [
                    [20.5937, 78.9629],
                    [20.6937, 79.0629]
                ];
                coords.forEach((coord, i) => {
                    L.marker(coord).addTo(map).bindPopup(i === 0 ? filteredData[0]['Source Station Name'] : filteredData[0]['Destination Station Name']);
                });
                L.polyline(coords, { color: '#3B82F6' }).addTo(map);
                map.fitBounds(coords);
            }
        });

        // Contact form
        document.getElementById('contact-submit').addEventListener('click', () => {
            const message = document.getElementById('contact-message').value;
            if (message) {
                const sentiment = aiFeatures.find(f => f.name === 'Feedback Sentiment Analysis').fn(message);
                const feedback = JSON.parse(localStorage.getItem('userFeedback') || '[]');
                feedback.push({ message, sentiment, timestamp: new Date().toISOString() });
                localStorage.setItem('userFeedback', JSON.stringify(feedback));
                document.getElementById('sentiment-analysis').innerHTML = `Sentiment: ${sentiment}`;
                alert('Feedback sent!');
                document.getElementById('contact-message').value = '';
            } else {
                alert('Please enter a message.');
            }
        });

        // AI features modal
        const showAiFeatures = document.getElementById('show-ai-features');
        const aiFeaturesModal = document.getElementById('ai-features-modal');
        const closeAiModal = document.getElementById('close-ai-modal');

        showAiFeatures.addEventListener('click', () => {
            aiFeaturesModal.style.display = 'flex';
        });

        closeAiModal.addEventListener('click', () => {
            aiFeaturesModal.style.display = 'none';
        });

        // Export report
        document.getElementById('export-report').addEventListener('click', () => {
            const trainNo = trainNumberInput.value.trim();
            const filteredData = trainData.filter(row => row['Train No']?.toString() === trainNo);
            if (!filteredData.length) {
                alert('Please select a train first.');
                return;
            }
            const report = {
                trainNo,
                trainName: filteredData[0]['Train Name'],
                schedule: [
                    { station: filteredData[0]['Source Station Name'], code: filteredData[0]['Source Station'], distance: 0 },
                    { station: filteredData[0]['Destination Station Name'], code: filteredData[0]['Destination Station'], distance: filteredData[0].Distance }
                ],
                thi: document.getElementById('thi-value').textContent,
                maintenance: maintenanceSuggestion.textContent,
                aiInsights: aiFeatures.filter(f => !f.upcoming).map(f => ({ name: f.name, result: f.fn(filteredData.length ? filteredData : generateSensorData()) }))
            };
            const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `train_${trainNo}_report.json`;
            a.click();
            URL.revokeObjectURL(url);
        });

        // User preferences
        function updateUserPreferences(username) {
            const prefs = JSON.parse(localStorage.getItem('userPrefs') || '{}');
            prefs.username = username;
            prefs.favoriteTrains = JSON.parse(localStorage.getItem('favorites') || '[]');
            prefs.lastLogin = new Date().toISOString();
            localStorage.setItem('userPrefs', JSON.stringify(prefs));
        }

        // Initialize
        fetchTrainData().then(updateFavorites);
    </script>
